@page
@model ChiTietHoaDonModel
@{
    ViewData["Title"] = "Chi tiết hóa đơn";
}

<div class="page-header">
    <div class="container">
        <h1 class="display-5"><i class="bi bi-receipt"></i> Chi tiết hóa đơn</h1>
    </div>
</div>

<div class="container">
    @if (Model.HoaDon == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Không tìm thấy hóa đơn!
        </div>
        <a href="/DanhSachBenhNhan" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
    }
    else
    {
        <!-- Header hóa đơn -->
        <div class="card mb-3 border-primary">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0"><i class="bi bi-receipt"></i> Hóa đơn thanh toán</h5>
                    </div>
                    <div class="col text-end">
                        <h6 class="mb-0">Mã hóa đơn: <strong>@Model.HoaDon.MaHd</strong></h6>
                        <small class="text-white-50">Ngày: @Model.HoaDon.NgayLap?.ToString("dd/MM/yyyy")</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Thông tin bệnh nhân</h6>
                        <p class="mb-1"><strong>Mã BN:</strong> @Model.BenhNhan?.MaBn</p>
                        <p class="mb-1"><strong>Họ tên:</strong> @Model.BenhNhan?.HoTenBn</p>
                        <p class="mb-1"><strong>Số điện thoại:</strong> @Model.BenhNhan?.Sdt</p>
                        <p class="mb-1"><strong>Ngày sinh:</strong> @Model.BenhNhan?.NgaySinh?.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Thông tin khám</h6>
                        <p class="mb-1"><strong>Mã phiếu khám:</strong> @Model.KhamBenh?.MaKham</p>
                        <p class="mb-1"><strong>Bác sĩ khám:</strong> @Model.BacSi?.HoTenBs</p>
                        <p class="mb-1"><strong>Ngày khám:</strong> @Model.KhamBenh?.NgayKham?.ToString("dd/MM/yyyy")</p>
                        @if (!string.IsNullOrEmpty(Model.BenhNhan?.Bhyt))
                        {
                            <p class="mb-1"><strong>BHYT:</strong> <span class="badge bg-success">@Model.BenhNhan.Bhyt</span></p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách thuốc -->
        <div class="card mb-3 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-prescription2"></i> Danh sách thuốc</h5>
            </div>
            <div class="card-body">
                @if (Model.DanhSachChiTiet.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Tên thuốc</th>
                                    <th class="text-end" style="width: 80px;">Số lượng</th>
                                    <th class="text-end" style="width: 100px;">Đơn giá</th>
                                    <th class="text-end" style="width: 100px;">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ct in Model.DanhSachChiTiet)
                                {
                                    <tr>
                                        <td>@ct.TenThuoc</td>
                                        <td class="text-end">@ct.SoLuong</td>
                                        <td class="text-end">@ct.DonGia.ToString("N0")</td>
                                        <td class="text-end fw-bold">@ct.ThanhTien.ToString("N0")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> Không có thuốc trong hóa đơn này.
                    </div>
                }
            </div>
        </div>

        <!-- Tổng tiền -->
        <div class="card mb-3 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-calculator"></i> Chi phí</h5>
            </div>
            <div class="card-body">
                <div class="row justify-content-end">
                    <div class="col-md-5">
                        <div class="row mb-2">
                            <div class="col-8">Tiền khám:</div>
                            <div class="col-4 text-end">100</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">Tiền thuốc:</div>
                            <div class="col-4 text-end">@Model.TongTienThuoc.ToString("N0")</div>
                        </div>
                        <hr />
                        <div class="row mb-2">
                            <div class="col-8 fw-bold">Tổng cộng:</div>
                            <div class="col-4 text-end fw-bold">@((100m + Model.TongTienThuoc).ToString("N0"))</div>
                        </div>

                        @if (Model.GiamGiaBHYT > 0)
                        {
                            <div class="alert alert-info mt-2 mb-2">
                                <small>
                                    <strong>Giảm giá BHYT (80%):</strong>
                                    <span class="float-end text-success">-@Model.GiamGiaBHYT.ToString("N0")</span>
                                </small>
                            </div>
                        }

                        <div class="row mt-2 p-2 bg-light rounded">
                            <div class="col-8 fw-bold" style="font-size: 18px;">Tiền thanh toán:</div>
                            <div class="col-4 text-end fw-bold text-danger" style="font-size: 18px;">@Model.HoaDon.ThanhTien.ToString("N0")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            <a href="/DanhSachBenhNhan" class="btn btn-secondary btn-lg">
                <i class="bi bi-arrow-left"></i> Quay lại danh sách
            </a>
            <button onclick="window.print()" class="btn btn-primary btn-lg">
                <i class="bi bi-printer"></i> In hóa đơn
            </button>
        </div>
    }
</div>